{{ define "main" }}
<style>
.booking-wrapper {
  max-width: 580px;
  margin: 40px auto;
  background: var(--entry, #1e1e1e);
  border-radius: 12px;
  padding: 36px 40px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.3);
}
.booking-wrapper h2 {
  text-align: center;
  margin-bottom: 8px;
  font-size: 1.5rem;
}
.booking-wrapper p.subtitle {
  text-align: center;
  color: var(--secondary, #aaa);
  margin-bottom: 28px;
  font-size: 0.95rem;
}
.form-group {
  display: flex;
  flex-direction: column;
  margin-bottom: 18px;
}
.form-group label {
  font-size: 0.9rem;
  font-weight: 600;
  margin-bottom: 6px;
  color: var(--primary, #ddd);
}
.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 10px 14px;
  border-radius: 8px;
  border: 1px solid var(--border, #444);
  background: var(--theme, #121212);
  color: var(--primary, #ddd);
  font-size: 1rem;
  box-sizing: border-box;
  transition: border-color 0.2s;
  appearance: none;
  -webkit-appearance: none;
}
.form-group select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23aaa' d='M6 8L0 0h12z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
  padding-right: 36px;
}
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #4e8ef7;
}
.form-group select:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
.service-tag {
  display: inline-block;
  font-size: 0.75rem;
  padding: 2px 8px;
  border-radius: 99px;
  margin-left: 6px;
  vertical-align: middle;
}
.tag-nail { background: #f3e5f5; color: #7b1fa2; }
.tag-lash { background: #e3f2fd; color: #1565c0; }
.submit-btn {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: none;
  background-color: #4e8ef7;
  color: white;
  font-size: 1.05rem;
  font-weight: 600;
  cursor: pointer;
  margin-top: 8px;
  transition: background-color 0.2s;
}
.submit-btn:hover { background-color: #3a7ae0; }
.submit-btn:disabled { background-color: #555; cursor: not-allowed; }
#form-status {
  text-align: center;
  margin-top: 14px;
  font-weight: bold;
  min-height: 24px;
}
</style>

<div class="booking-wrapper">
  <h2>ç·šä¸Šé ç´„</h2>
  <p class="subtitle">æ­¡è¿å¡«å¯«é ç´„è¡¨å–®ï¼Œæˆ‘å€‘æ”¶åˆ°ç”³è«‹å¾Œæœƒç›¡å¿«ç¢ºèªä¸¦å›è¦†ã€‚</p>
  <form id="booking-form">

    <!-- åŸºæœ¬è³‡æ–™ -->
    <div class="form-group">
      <label for="name">å§“å</label>
      <input type="text" id="name" name="name" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" required>
    </div>
    <div class="form-group">
      <label for="email">é›»å­éƒµä»¶</label>
      <input type="email" id="email" name="email" placeholder="example@email.com" required>
    </div>
    <div class="form-group">
      <label for="phone">è¯çµ¡é›»è©±</label>
      <input type="tel" id="phone" name="phone" placeholder="0912-345-678" required>
    </div>

    <!-- æœå‹™é¸æ“‡ï¼ˆå…©éšæ®µï¼‰ -->
    <div class="form-group">
      <label for="category">æœå‹™é¡åˆ¥</label>
      <select id="category" name="category" required>
        <option value="">è«‹é¸æ“‡æœå‹™é¡åˆ¥</option>
        <option value="nail">ğŸ’… ç¾ç”²</option>
        <option value="lash">âœ¨ ç¾ç«</option>
      </select>
    </div>
    <div class="form-group">
      <label for="service">
        æœå‹™é …ç›®
        <span id="service-tag" class="service-tag" style="display:none;"></span>
      </label>
      <select id="service" name="service" required disabled>
        <option value="">è«‹å…ˆé¸æ“‡æœå‹™é¡åˆ¥</option>
      </select>
    </div>

    <!-- æ—¥æœŸ & æ™‚é–“ -->
    <div class="form-row">
      <div class="form-group">
        <label for="date">é ç´„æ—¥æœŸ</label>
        <input type="date" id="date" name="date" required>
      </div>
      <div class="form-group">
        <label for="time">é ç´„æ™‚é–“</label>
        <input type="time" id="time" name="time" required>
      </div>
    </div>

    <!-- å‚™è¨» -->
    <div class="form-group">
      <label for="notes">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
      <textarea id="notes" name="notes" rows="3" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚ã€åƒè€ƒåœ–ç‰‡é€£çµç­‰è«‹åœ¨æ­¤èªªæ˜"></textarea>
    </div>

    <button type="submit" class="submit-btn">é€å‡ºé ç´„</button>
    <div id="form-status"></div>
  </form>
</div>

<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  // =====================================================
  // â˜… è¨­å®šå€ï¼šè«‹å¡«å…¥ä½ çš„ EmailJS è³‡è¨Šï¼ˆè¦‹ä¸‹æ–¹èªªæ˜ï¼‰
  // =====================================================
  const EMAILJS_PUBLIC_KEY  = "ydXq_gMt59U_Zfwz9";   // EmailJS > Account > Public Key
  const EMAILJS_SERVICE_ID  = "service_4qxqcjt";   // EmailJS > Email Services > Service ID
  const EMAILJS_TEMPLATE_ID = "template_jsrd2gm";  // EmailJS > Email Templates > Template ID
  // =====================================================

  emailjs.init(EMAILJS_PUBLIC_KEY);

  // æœå‹™é …ç›®è³‡æ–™ï¼ˆå¯è‡ªè¡Œä¿®æ”¹ï¼‰
  const SERVICES = {
    nail: {
      label: "ç¾ç”²",
      tagClass: "tag-nail",
      items: [
        "å‡è† æŒ‡ç”²ï¼ˆç´ è‰²ï¼‰",
        "å‡è† æŒ‡ç”²ï¼ˆè¨­è¨ˆæ¬¾ï¼‰",
        "å…‰ç™‚æŒ‡ç”²",
        "å»¶ç”²",
        "å¸ç”²",
      ]
    },
    lash: {
      label: "ç¾ç«",
      tagClass: "tag-lash",
      items: [
        "è‡ªç„¶æ¬¾ï¼ˆå–®æ ¹å«æ¥ï¼‰",
        "è¤‡åˆæ¬¾",
        "æ¿ƒå¯†æ¬¾ï¼ˆèŠ±æŸç«æ¯›ï¼‰",
        "è£œç«æ¯›",
        "å¸é™¤ç«æ¯›",
      ]
    }
  };

  // è¨­å®šæ—¥æœŸæœ€å°å€¼ç‚ºä»Šå¤©
  document.getElementById("date").min = new Date().toISOString().split("T")[0];

  // é¡åˆ¥åˆ‡æ› â†’ å‹•æ…‹è¼‰å…¥æœå‹™é …ç›®
  document.getElementById("category").addEventListener("change", function () {
    const serviceSelect = document.getElementById("service");
    const tag = document.getElementById("service-tag");
    const val = this.value;

    if (val && SERVICES[val]) {
      const { label, tagClass, items } = SERVICES[val];
      serviceSelect.innerHTML = `<option value="">è«‹é¸æ“‡${label}é …ç›®</option>`;
      items.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item;
        opt.textContent = item;
        serviceSelect.appendChild(opt);
      });
      serviceSelect.disabled = false;
      tag.textContent = label;
      tag.className = `service-tag ${tagClass}`;
      tag.style.display = "inline-block";
    } else {
      serviceSelect.innerHTML = "<option value=''>è«‹å…ˆé¸æ“‡æœå‹™é¡åˆ¥</option>";
      serviceSelect.disabled = true;
      tag.style.display = "none";
    }
  });

  // è¡¨å–®é€å‡º
  document.getElementById("booking-form").addEventListener("submit", async function (e) {
    e.preventDefault();
    const form = e.target;
    const statusDiv = document.getElementById("form-status");
    const submitBtn = form.querySelector(".submit-btn");

    statusDiv.textContent = "å‚³é€ä¸­...";
    statusDiv.style.color = "#4e8ef7";
    submitBtn.disabled = true;

    const name     = document.getElementById("name").value.trim();
    const email    = document.getElementById("email").value.trim();
    const phone    = document.getElementById("phone").value.trim();
    const catVal   = document.getElementById("category").value;
    const category = SERVICES[catVal]?.label || catVal;
    const service  = document.getElementById("service").value;
    const date     = document.getElementById("date").value;
    const time     = document.getElementById("time").value;
    const notes    = document.getElementById("notes").value.trim() || "ç„¡";

    // ç”¢ç”Ÿ Google Calendar é€£çµï¼ˆç€è¦½å™¨æœ¬åœ°æ™‚é–“ï¼Œå°ç£æ™‚å€æ­£ç¢ºï¼‰
    const startTime = new Date(`${date}T${time}:00`);
    const endTime   = new Date(startTime.getTime() + 90 * 60 * 1000); // é è¨­ 90 åˆ†é˜
    const fmt = (d) => d.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";

    const gcalText    = encodeURIComponent(`é ç´„ ${category}ï¼š${name}`);
    const gcalDetails = encodeURIComponent(
      `æœå‹™ï¼š${category} - ${service}\nå§“åï¼š${name}\né›»è©±ï¼š${phone}\nä¿¡ç®±ï¼š${email}\nå‚™è¨»ï¼š${notes}`
    );
    const gcalLink = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${gcalText}&dates=${fmt(startTime)}/${fmt(endTime)}&details=${gcalDetails}`;

    // æ—¥æœŸæ ¼å¼åŒ–é¡¯ç¤º
    const dateDisplay = new Date(`${date}T00:00:00`).toLocaleDateString("zh-TW", {
      year: "numeric", month: "long", day: "numeric", weekday: "short"
    });

    const templateParams = {
      name, email, phone,
      category, service,
      date: dateDisplay,
      time,
      notes,
      gcal_link: gcalLink,
    };

    try {
      await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
      statusDiv.innerHTML = "âœ… é ç´„ç”³è«‹å·²é€å‡ºï¼æˆ‘å€‘æœƒç›¡å¿«èˆ‡æ‚¨ç¢ºèªé ç´„æ™‚é–“ã€‚";
      statusDiv.style.color = "#4caf50";
      form.reset();
      document.getElementById("service").disabled = true;
      document.getElementById("service-tag").style.display = "none";
    } catch (err) {
      console.error("EmailJS error:", err);
      statusDiv.textContent = "å‚³é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–ç›´æ¥è¯çµ¡æˆ‘å€‘ã€‚";
      statusDiv.style.color = "#f44336";
    } finally {
      submitBtn.disabled = false;
    }
  });
</script>
{{ end }}
