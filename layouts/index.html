{{ define "main" }}
<style>
/* ===== RESET & WRAPPER ===== */
*, *::before, *::after { box-sizing: border-box; }

.booking-wrapper {
  max-width: 600px;
  margin: 32px auto;
  padding: 0 16px 60px;
}
.booking-wrapper h2 {
  text-align: center;
  font-size: 1.5rem;
  margin-bottom: 4px;
  letter-spacing: -0.01em;
}
.booking-wrapper p.subtitle {
  text-align: center;
  color: var(--secondary, #999);
  margin-bottom: 24px;
  font-size: 0.9rem;
}

/* ===== CARD (æ¯å€‹æ­¥é©Ÿçš„å®¹å™¨) ===== */
.step-card {
  background: var(--entry, #1e1e1e);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.15), 0 4px 20px rgba(0,0,0,0.2);
}

/* ===== æ­¥é©Ÿæ¨™é¡Œï¼ˆåœ“å½¢æ•¸å­— + æ–‡å­—ï¼‰===== */
.step-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 18px;
}
.step-num {
  width: 26px; height: 26px;
  border-radius: 50%;
  background: #4e8ef7;
  color: #fff;
  font-size: 0.8rem;
  font-weight: 800;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  letter-spacing: 0;
}
.step-label {
  font-size: 0.95rem;
  font-weight: 700;
  color: var(--primary, #ddd);
}

/* ===== CALENDAR ===== */
.cal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}
.cal-month-title {
  font-weight: 700;
  font-size: 1rem;
}
/* â˜… ä¿®æ­£ï¼šè§¸æ§æœ€å° 44px */
.cal-nav {
  width: 44px; height: 44px;
  border-radius: 10px;
  background: none;
  border: 1px solid var(--border, #444);
  color: var(--primary, #ddd);
  font-size: 1.3rem;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
  -webkit-tap-highlight-color: transparent;
}
.cal-nav:hover:not(:disabled) { background: rgba(78,142,247,0.15); border-color: #4e8ef7; }
.cal-nav:active:not(:disabled) { background: rgba(78,142,247,0.3); }
.cal-nav:disabled { opacity: 0.2; cursor: default; }

.cal-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}
.cal-day-label {
  text-align: center;
  font-size: 0.7rem;
  color: var(--secondary, #888);
  padding: 3px 0 8px;
  font-weight: 600;
}
/* â˜… ä¿®æ­£ï¼šæœ€å°è§¸æ§é«˜åº¦ï¼Œaspect-ratio ä¿æŒæ­£æ–¹ */
.cal-day {
  aspect-ratio: 1;
  min-height: 40px;
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.9rem;
  cursor: pointer;
  border: 1.5px solid transparent;
  transition: background 0.12s, border-color 0.12s;
  user-select: none;
  position: relative;
  -webkit-tap-highlight-color: transparent;
}
.cal-day:hover:not(.cal-past):not(.cal-empty):not(.cal-full) {
  background: rgba(78,142,247,0.15); border-color: rgba(78,142,247,0.4);
}
.cal-day:active:not(.cal-past):not(.cal-empty):not(.cal-full) {
  background: rgba(78,142,247,0.3);
}
.cal-day.cal-today     { border-color: #4e8ef7; font-weight: 700; }
.cal-day.cal-selected  { background: #4e8ef7 !important; border-color: #4e8ef7; color: #fff; font-weight: 700; }
.cal-day.cal-past,
.cal-day.cal-empty     { color: var(--secondary, #444); cursor: default; pointer-events: none; }
.cal-day.cal-full      { opacity: 0.35; cursor: default; pointer-events: none; text-decoration: line-through; }
/* æœ‰é ç´„çš„æ—¥æœŸåº•éƒ¨å°é» */
.cal-day.cal-has-booking::after {
  content: '';
  position: absolute;
  bottom: 4px; left: 50%;
  transform: translateX(-50%);
  width: 4px; height: 4px;
  border-radius: 50%;
  background: #4e8ef7;
}
.cal-day.cal-selected::after { background: rgba(255,255,255,0.8); }

/* ===== TIME SLOTS ===== */
.slots-placeholder {
  text-align: center;
  color: var(--secondary, #888);
  font-size: 0.88rem;
  padding: 20px 0;
}
/* â˜… ä¿®æ­£ï¼šauto-fill è‡ªé©æ‡‰æ¬„ä½ï¼Œæ‰‹æ©Ÿæœƒé¡¯ç¤º 3 æ¬„ */
.slots-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(82px, 1fr));
  gap: 8px;
}
/* â˜… ä¿®æ­£ï¼šmin-height 56px ç¢ºä¿è§¸æ§ç›®æ¨™ */
.slot-btn {
  min-height: 56px;
  padding: 8px 4px;
  border-radius: 12px;
  border: 1.5px solid var(--border, #3a3a3a);
  background: var(--theme, #141414);
  color: var(--primary, #ddd);
  font-size: 0.92rem;
  font-weight: 700;
  cursor: pointer;
  text-align: center;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 3px;
  transition: background 0.12s, border-color 0.12s, transform 0.08s;
  -webkit-tap-highlight-color: transparent;
}
.slot-btn:hover:not(:disabled) { border-color: #4e8ef7; background: rgba(78,142,247,0.1); }
.slot-btn:active:not(:disabled) { transform: scale(0.95); }
.slot-btn.selected  { background: #4e8ef7; border-color: #4e8ef7; color: #fff; }
.slot-btn:disabled  {
  background: rgba(255,255,255,0.02);
  color: var(--secondary, #555);
  cursor: default;
  border-color: transparent;
}
.slot-time { font-size: 0.92rem; font-weight: 700; line-height: 1; }
.slot-surcharge {
  font-size: 0.6rem;
  font-weight: 500;
  color: #f59e0b;
  line-height: 1;
}
.slot-btn.selected .slot-surcharge { color: #fde68a; }
.slot-booked {
  font-size: 0.6rem;
  color: var(--secondary, #555);
  line-height: 1;
}

/* è¼‰å…¥ Spinner */
.spinner-wrap {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 20px 0;
  color: var(--secondary, #888);
  font-size: 0.88rem;
}
.spinner {
  width: 18px; height: 18px;
  border: 2px solid rgba(78,142,247,0.2);
  border-top-color: #4e8ef7;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ===== FORM STEPï¼ˆéš±è— â†’ é¡¯ç¤ºå¸¶å‹•ç•«ï¼‰===== */
.form-step { display: none; }
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}
.form-step.visible {
  display: block;
  animation: fadeSlideIn 0.22s ease;
}

/* å·²é¸æ‘˜è¦ */
.selected-summary {
  background: rgba(78,142,247,0.08);
  border: 1px solid rgba(78,142,247,0.25);
  border-radius: 12px;
  padding: 14px 16px;
  margin-bottom: 20px;
  font-size: 0.9rem;
  line-height: 1.8;
}
.selected-summary strong { color: #4e8ef7; }
.surcharge-notice {
  display: inline-flex; align-items: center; gap: 4px;
  background: rgba(245,158,11,0.12);
  border: 1px solid rgba(245,158,11,0.35);
  color: #f59e0b;
  border-radius: 6px;
  padding: 2px 8px;
  font-size: 0.78rem;
  font-weight: 600;
  margin-top: 4px;
}

/* ===== FORM ===== */
.form-group { display: flex; flex-direction: column; margin-bottom: 14px; }
.form-group label {
  font-size: 0.82rem;
  font-weight: 600;
  margin-bottom: 5px;
  color: var(--secondary, #aaa);
  letter-spacing: 0.02em;
}
/* â˜… ä¿®æ­£ï¼šmin-height 48pxï¼Œfont-size 16px é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  min-height: 48px;
  padding: 12px 14px;
  border-radius: 10px;
  border: 1.5px solid var(--border, #3a3a3a);
  background: var(--theme, #141414);
  color: var(--primary, #ddd);
  font-size: 16px; /* é˜² iOS zoom */
  transition: border-color 0.15s;
  appearance: none; -webkit-appearance: none;
}
.form-group select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23888' d='M6 8L0 0h12z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
  padding-right: 38px;
}
.form-group textarea { min-height: 80px; resize: vertical; }
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus { outline: none; border-color: #4e8ef7; }
.form-group select:disabled { opacity: 0.4; cursor: not-allowed; }

.service-tag {
  display: inline-block; font-size: 0.7rem; padding: 2px 8px;
  border-radius: 99px; margin-left: 6px; vertical-align: middle;
}
.tag-nail { background: #f3e5f5; color: #7b1fa2; }
.tag-lash { background: #e3f2fd; color: #1565c0; }

/* â˜… ä¿®æ­£ï¼šé€å‡ºæŒ‰éˆ• 50px é«˜ï¼Œæ‰‹æ©Ÿå‹å–„ */
.submit-btn {
  width: 100%;
  min-height: 50px;
  padding: 14px;
  border-radius: 12px;
  border: none;
  background: #4e8ef7;
  color: #fff;
  font-size: 1.05rem;
  font-weight: 700;
  cursor: pointer;
  margin-top: 6px;
  transition: background 0.15s, transform 0.08s;
  display: flex; align-items: center; justify-content: center; gap: 8px;
  -webkit-tap-highlight-color: transparent;
}
.submit-btn:hover  { background: #3a7ae0; }
.submit-btn:active { transform: scale(0.98); }
.submit-btn:disabled { background: #555; cursor: not-allowed; transform: none; }

/* é€å‡ºä¸­ spinnerï¼ˆå°ï¼‰*/
.btn-spinner {
  width: 16px; height: 16px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}

/* ===== æˆåŠŸç•«é¢ ===== */
#success-card {
  display: none;
  text-align: center;
  padding: 12px 8px 4px;
  animation: fadeSlideIn 0.3s ease;
}
.success-icon {
  width: 60px; height: 60px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto 16px;
  font-size: 1.8rem;
  color: white;
  background: #22c55e;
}
.success-icon.pending-icon { background: #f59e0b; }
#success-card h3 {
  font-size: 1.15rem;
  margin-bottom: 6px;
  color: var(--primary, #ddd);
}
#success-card p {
  font-size: 0.88rem;
  color: var(--secondary, #aaa);
  margin-bottom: 16px;
  line-height: 1.6;
}
.success-detail {
  background: rgba(78,142,247,0.08);
  border: 1px solid rgba(78,142,247,0.2);
  border-radius: 12px;
  padding: 14px 16px;
  text-align: left;
  font-size: 0.9rem;
  line-height: 2;
  margin-bottom: 20px;
  color: var(--primary, #ddd);
}
.success-detail strong { color: #4e8ef7; }
.new-booking-btn {
  width: 100%; padding: 13px;
  border-radius: 12px;
  border: 1.5px solid var(--border, #444);
  background: none;
  color: var(--primary, #ddd);
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.15s;
  -webkit-tap-highlight-color: transparent;
}
.new-booking-btn:hover { background: rgba(78,142,247,0.08); border-color: #4e8ef7; color: #4e8ef7; }

/* ===== RWD â€” çª„è¢å¹•å¾®èª¿ ===== */
@media (max-width: 400px) {
  .step-card { padding: 16px 14px; }
  .slots-grid { grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); gap: 6px; }
  .booking-wrapper { padding: 0 10px 60px; }
}
</style>

<div class="booking-wrapper">
  <h2>ç·šä¸Šé ç´„</h2>
  <p class="subtitle">é¸æ“‡æ—¥æœŸèˆ‡æ™‚æ®µï¼Œå¡«å¯«è³‡æ–™å¾Œé€å‡ºé ç´„</p>

  <!-- â‘  é¸æ“‡æ—¥æœŸ -->
  <div class="step-card">
    <div class="step-header">
      <div class="step-num">1</div>
      <span class="step-label">é¸æ“‡æ—¥æœŸ</span>
    </div>
    <div class="cal-header">
      <button class="cal-nav" id="cal-prev">â€¹</button>
      <span class="cal-month-title" id="cal-title"></span>
      <button class="cal-nav" id="cal-next">â€º</button>
    </div>
    <div class="cal-grid" id="cal-grid"></div>
  </div>

  <!-- â‘¡ é¸æ“‡æ™‚æ®µ -->
  <div class="step-card">
    <div class="step-header">
      <div class="step-num">2</div>
      <span class="step-label">é¸æ“‡æ™‚æ®µ</span>
    </div>
    <div id="slots-container">
      <div class="slots-placeholder">è«‹å…ˆé¸æ“‡æ—¥æœŸ</div>
    </div>
  </div>

  <!-- â‘¢ å¡«å¯«è³‡æ–™ï¼ˆé¸å®Œæ™‚æ®µå¾Œ fade inï¼‰-->
  <div class="step-card form-step" id="form-step">
    <div class="step-header">
      <div class="step-num">3</div>
      <span class="step-label">å¡«å¯«é ç´„è³‡æ–™</span>
    </div>

    <!-- å·²é¸æ‘˜è¦ -->
    <div class="selected-summary" id="selected-summary"></div>

    <!-- è¡¨å–® -->
    <form id="booking-form">
      <div class="form-group">
        <label for="name">å§“å</label>
        <input type="text" id="name" name="name" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" required autocomplete="name">
      </div>
      <div class="form-group">
        <label for="phone">è¯çµ¡é›»è©±</label>
        <input type="tel" id="phone" name="phone" placeholder="0912-345-678" required autocomplete="tel">
      </div>
      <div class="form-group">
        <label for="email">é›»å­éƒµä»¶</label>
        <input type="email" id="email" name="email" placeholder="example@email.com" required autocomplete="email">
      </div>
      <div class="form-group">
        <label for="category">æœå‹™é¡åˆ¥</label>
        <select id="category" name="category" required>
          <option value="">è«‹é¸æ“‡æœå‹™é¡åˆ¥</option>
          <option value="nail">ğŸ’… ç¾ç”²</option>
          <option value="lash">âœ¨ ç¾ç«</option>
        </select>
      </div>
      <div class="form-group">
        <label for="service">
          æœå‹™é …ç›®
          <span id="service-tag" class="service-tag" style="display:none;"></span>
        </label>
        <select id="service" name="service" required disabled>
          <option value="">è«‹å…ˆé¸æ“‡æœå‹™é¡åˆ¥</option>
        </select>
      </div>
      <div class="form-group">
        <label for="notes">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
        <textarea id="notes" name="notes" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚ã€åƒè€ƒåœ–ç‰‡é€£çµç­‰è«‹åœ¨æ­¤èªªæ˜"></textarea>
      </div>
      <button type="submit" class="submit-btn" id="submit-btn">é€å‡ºé ç´„</button>
    </form>

    <!-- å¾…ç¢ºèªç•«é¢ï¼ˆé€å‡ºå¾Œæ›¿æ›è¡¨å–®ï¼‰-->
    <div id="success-card">
      <div class="success-icon pending-icon">â³</div>
      <h3>ç”³è«‹å·²é€å‡ºï¼Œç­‰å¾…ç¢ºèªä¸­</h3>
      <p>æˆ‘å€‘å·²å¯„é€æ”¶åˆ°é€šçŸ¥åˆ°æ‚¨çš„ä¿¡ç®±ã€‚<br>åº—å®¶ç¢ºèªå¾Œæœƒå†å¯„ç™¼æ­£å¼ç¢ºèªä¿¡ï¼Œ<br>è«‹ç•™æ„ä¿¡ç®±ã€‚</p>
      <div class="success-detail" id="success-detail"></div>
      <button class="new-booking-btn" onclick="resetBooking()">å†é ç´„ä¸€æ¬¡</button>
    </div>
  </div>
</div>

<script>
// =====================================================
// â˜… è¨­å®šå€
// =====================================================
const APPS_SCRIPT_URL = "YOUR_APPS_SCRIPT_URL"; // â† éƒ¨ç½² Apps Script å¾Œå¡«å…¥

// ç‡Ÿæ¥­è¨­å®š
const OPEN_HOUR        = 8;
const CLOSE_HOUR       = 20;
const SLOT_MINS        = 60;
const SURCHARGE_HOUR   = 19;
const SURCHARGE_AMOUNT = 200;
// =====================================================

const SERVICES = {
  nail: {
    label: "ç¾ç”²", tagClass: "tag-nail",
    items: ["å‡è† æŒ‡ç”²ï¼ˆç´ è‰²ï¼‰","å‡è† æŒ‡ç”²ï¼ˆè¨­è¨ˆæ¬¾ï¼‰","å…‰ç™‚æŒ‡ç”²","å»¶ç”²","å¸ç”²"]
  },
  lash: {
    label: "ç¾ç«", tagClass: "tag-lash",
    items: ["è‡ªç„¶æ¬¾ï¼ˆå–®æ ¹å«æ¥ï¼‰","è¤‡åˆæ¬¾","æ¿ƒå¯†æ¬¾ï¼ˆèŠ±æŸç«æ¯›ï¼‰","è£œç«æ¯›","å¸é™¤ç«æ¯›"]
  }
};

function generateSlots() {
  const s = [];
  for (let h = OPEN_HOUR; h < CLOSE_HOUR; h++) s.push(`${String(h).padStart(2,'0')}:00`);
  return s;
}
const ALL_SLOTS = generateSlots();

let bookedSet    = new Set();
let slotsReady   = false;
let selectedDate = null;
let selectedTime = null;

const today = new Date();
today.setHours(0, 0, 0, 0);

// ===== è®€å–å·²é ç´„æ™‚æ®µ =====
async function loadBookedSlots() {
  if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === "YOUR_APPS_SCRIPT_URL") {
    slotsReady = true; return;
  }
  try {
    const res  = await fetch(`${APPS_SCRIPT_URL}?action=getBooked`);
    const data = await res.json();
    bookedSet  = new Set(data.booked || []);
  } catch (e) {
    console.warn("ç„¡æ³•è®€å–é ç´„ç´€éŒ„ï¼š", e);
  } finally {
    slotsReady = true;
    renderCalendar();
    if (selectedDate) renderTimeSlots(selectedDate);
  }
}

// ===== æ—¥æ›† =====
let calYear, calMonth;
function initCalendar() {
  calYear  = today.getFullYear();
  calMonth = today.getMonth();
  renderCalendar();
  document.getElementById("cal-prev").onclick = () => { calMonth--; if (calMonth < 0) { calMonth = 11; calYear--; } renderCalendar(); };
  document.getElementById("cal-next").onclick = () => { calMonth++; if (calMonth > 11) { calMonth = 0; calYear++; } renderCalendar(); };
}

function renderCalendar() {
  const prevBtn = document.getElementById("cal-prev");
  prevBtn.disabled = (calYear === today.getFullYear() && calMonth === today.getMonth());
  document.getElementById("cal-title").textContent = `${calYear} å¹´ ${calMonth + 1} æœˆ`;

  const grid = document.getElementById("cal-grid");
  grid.innerHTML = "";

  ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"].forEach(d => {
    const el = document.createElement("div");
    el.className = "cal-day-label";
    el.textContent = d;
    grid.appendChild(el);
  });

  const firstDay = new Date(calYear, calMonth, 1);
  let offset = firstDay.getDay();
  offset = (offset === 0) ? 6 : offset - 1;
  for (let i = 0; i < offset; i++) {
    const el = document.createElement("div"); el.className = "cal-day cal-empty"; grid.appendChild(el);
  }

  const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
  for (let d = 1; d <= daysInMonth; d++) {
    const el = document.createElement("div");
    el.className = "cal-day";
    el.textContent = d;
    const dateStr = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayDate = new Date(calYear, calMonth, d);

    if (dayDate < today) {
      el.classList.add("cal-past");
    } else {
      if (dayDate.getTime() === today.getTime()) el.classList.add("cal-today");
      if (slotsReady) {
        const cnt = ALL_SLOTS.filter(s => bookedSet.has(`${dateStr}_${s}`)).length;
        if (cnt === ALL_SLOTS.length) el.classList.add("cal-full");
        else if (cnt > 0) el.classList.add("cal-has-booking");
      }
      if (dateStr === selectedDate) el.classList.add("cal-selected");
      el.onclick = () => selectDate(dateStr);
    }
    grid.appendChild(el);
  }
}

function selectDate(dateStr) {
  selectedDate = dateStr;
  selectedTime = null;
  renderCalendar();
  renderTimeSlots(dateStr);
  document.getElementById("form-step").classList.remove("visible");
}

// ===== æ™‚æ®µæ ¼ =====
function renderTimeSlots(dateStr) {
  const container = document.getElementById("slots-container");

  // è®€å–ä¸­ï¼šé¡¯ç¤º spinner
  if (!slotsReady) {
    container.innerHTML = `
      <div class="spinner-wrap">
        <div class="spinner"></div>
        <span>è®€å–å¯ç”¨æ™‚æ®µâ€¦</span>
      </div>`;
    return;
  }

  const grid = document.createElement("div");
  grid.className = "slots-grid";

  ALL_SLOTS.forEach(slot => {
    const btn         = document.createElement("button");
    btn.type          = "button";
    btn.className     = "slot-btn";
    const hour        = parseInt(slot);
    const isBooked    = bookedSet.has(`${dateStr}_${slot}`);
    const isSurcharge = hour >= SURCHARGE_HOUR;

    const timeEl = document.createElement("span");
    timeEl.className = "slot-time";
    timeEl.textContent = slot;
    btn.appendChild(timeEl);

    if (isSurcharge) {
      const badge = document.createElement("span");
      badge.className   = "slot-surcharge";
      badge.textContent = `+NT$${SURCHARGE_AMOUNT}`;
      btn.appendChild(badge);
    }

    if (isBooked) {
      btn.disabled = true;
      const lb = document.createElement("span");
      lb.className   = "slot-booked";
      lb.textContent = "å·²é ç´„";
      btn.appendChild(lb);
    } else {
      if (slot === selectedTime) btn.classList.add("selected");
      btn.onclick = () => selectTime(slot, isSurcharge);
    }
    grid.appendChild(btn);
  });

  container.innerHTML = "";
  container.appendChild(grid);
}

function selectTime(slot, isSurcharge) {
  selectedTime = slot;
  renderTimeSlots(selectedDate);

  const d = new Date(selectedDate + "T00:00:00");
  const dateDisplay = d.toLocaleDateString("zh-TW", {
    year: "numeric", month: "long", day: "numeric", weekday: "short"
  });

  let html = `ğŸ“… <strong>${dateDisplay}</strong><br>ğŸ• <strong>${slot}</strong>`;
  if (isSurcharge) {
    html += `<br><span class="surcharge-notice">âš  æ­¤æ™‚æ®µåŠ æ”¶ NT$${SURCHARGE_AMOUNT} åŠ ç­è²»</span>`;
  }
  document.getElementById("selected-summary").innerHTML = html;

  const formStep = document.getElementById("form-step");
  formStep.classList.add("visible");
  setTimeout(() => formStep.scrollIntoView({ behavior: "smooth", block: "nearest" }), 60);
}

// ===== æœå‹™é¸å–® =====
document.getElementById("category").addEventListener("change", function () {
  const sel = document.getElementById("service");
  const tag = document.getElementById("service-tag");
  const val = this.value;
  if (val && SERVICES[val]) {
    const { label, tagClass, items } = SERVICES[val];
    sel.innerHTML = `<option value="">è«‹é¸æ“‡${label}é …ç›®</option>`;
    items.forEach(item => {
      const o = document.createElement("option"); o.value = item; o.textContent = item; sel.appendChild(o);
    });
    sel.disabled   = false;
    tag.textContent = label;
    tag.className   = `service-tag ${tagClass}`;
    tag.style.display = "inline-block";
  } else {
    sel.innerHTML = "<option value=''>è«‹å…ˆé¸æ“‡æœå‹™é¡åˆ¥</option>";
    sel.disabled  = true;
    tag.style.display = "none";
  }
});

// ===== é€å‡ºé ç´„ =====
document.getElementById("booking-form").addEventListener("submit", async function (e) {
  e.preventDefault();
  const submitBtn = document.getElementById("submit-btn");

  if (!selectedDate || !selectedTime) {
    alert("è«‹å…ˆé¸æ“‡æ—¥æœŸèˆ‡æ™‚æ®µï¼"); return;
  }

  if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === "YOUR_APPS_SCRIPT_URL") {
    alert("å°šæœªè¨­å®š Apps Script ç¶²å€ï¼Œè«‹è¯çµ¡åº—å®¶ã€‚"); return;
  }

  submitBtn.disabled  = true;
  submitBtn.innerHTML = `<span class="btn-spinner"></span> å‚³é€ä¸­â€¦`;

  const name     = document.getElementById("name").value.trim();
  const email    = document.getElementById("email").value.trim();
  const phone    = document.getElementById("phone").value.trim();
  const catVal   = document.getElementById("category").value;
  const category = SERVICES[catVal]?.label || catVal;
  const service  = document.getElementById("service").value;
  const notes    = document.getElementById("notes").value.trim() || "ç„¡";
  const hour     = parseInt(selectedTime);
  const hasSurcharge = hour >= SURCHARGE_HOUR;

  const dateDisplay = new Date(`${selectedDate}T00:00:00`).toLocaleDateString("zh-TW", {
    year: "numeric", month: "long", day: "numeric", weekday: "short"
  });

  try {
    const params = new URLSearchParams({
      action: "book",
      date: selectedDate, time: selectedTime,
      name, phone, email, category, service, notes
    });
    const res  = await fetch(`${APPS_SCRIPT_URL}?${params}`);
    const data = await res.json();

    if (!data.success) throw new Error(data.error || "unknown error");

    // ä½”ç”¨æ™‚æ®µï¼ˆæœ¬åœ°ç«‹å³åç°ï¼‰
    bookedSet.add(`${selectedDate}_${selectedTime}`);
    renderCalendar();

    // é¡¯ç¤ºå¾…ç¢ºèªç•«é¢
    document.getElementById("booking-form").style.display = "none";
    document.getElementById("selected-summary").style.display = "none";

    let detailHtml = `
      ğŸ“… <strong>${dateDisplay}</strong><br>
      ğŸ• <strong>${selectedTime}</strong><br>
      âœ‚ï¸ <strong>${category}ï½œ${service}</strong><br>
      ğŸ‘¤ ${name}ã€€ğŸ“ ${phone}<br>
      ğŸ“§ ${email}`;
    if (hasSurcharge) detailHtml += `<br>âš ï¸ <span style="color:#f59e0b;">åŠ ç­è²» NT$${SURCHARGE_AMOUNT}</span>`;

    document.getElementById("success-detail").innerHTML = detailHtml;
    const card = document.getElementById("success-card");
    card.style.display = "block";
    card.scrollIntoView({ behavior: "smooth", block: "center" });

    selectedTime = null;
    renderTimeSlots(selectedDate);

  } catch (err) {
    console.error("é€å‡ºå¤±æ•—ï¼š", err);
    submitBtn.disabled  = false;
    submitBtn.innerHTML = "é€å‡ºé ç´„";
    alert("å‚³é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–ç›´æ¥ä¾†é›»è¯çµ¡ã€‚");
  }
});

// ===== å†é ç´„ä¸€æ¬¡ =====
function resetBooking() {
  document.getElementById("booking-form").style.display = "";
  document.getElementById("selected-summary").style.display = "";
  document.getElementById("success-card").style.display = "none";
  document.getElementById("submit-btn").disabled  = false;
  document.getElementById("submit-btn").innerHTML = "é€å‡ºé ç´„";
  document.getElementById("booking-form").reset();
  document.getElementById("service").disabled = true;
  document.getElementById("service-tag").style.display = "none";
  document.getElementById("form-step").classList.remove("visible");
  selectedTime = null;
  window.scrollTo({ top: 0, behavior: "smooth" });
}

// ===== åˆå§‹åŒ– =====
initCalendar();
loadBookedSlots();
</script>
{{ end }}
